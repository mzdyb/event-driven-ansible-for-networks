---
- name: Manage incident - interface down
  hosts: localhost
  vars:
    host: https://dev271481.service-now.com/
    username: admin
    password: yDpOvP5$Bn-2

  tasks:
    - name: Create incident
      servicenow.itsm.incident:
        instance:
          host: "{{ host }}"
          username: "{{ username }}"
          password: "{{ password }}"
        state: new
        caller: ansible.eda
        short_description: Interface down
        description: Interface {{ interface }} on device {{ device }} is operationally down
        impact: low
        urgency: low
      register: new_incident
      tags: [create_incident, all]

    - name: Update the incident with resolution comments
      servicenow.itsm.incident:
        instance:
          host: "{{ host }}"
          username: "{{ username }}"
          password: "{{ password }}"
        number: "{{ new_incident.record.number }}"
        state: in_progress
        other:
          work_notes: "Bounced interface {{ interface }} and verifying if it still operationally down"
      tags: [update_incident, all]

    - name: Close the incident if resolved
      servicenow.itsm.incident:
        instance:
          host: "{{ host }}"
          username: "{{ username }}"
          password: "{{ password }}"
        number: "{{ new_incident.record.number }}"
        state: closed
        close_code: "Solution provided"
        close_notes: "Bouncing interface solved the issue, interface {{ interface }} is up"
      tags: [close_incident, all]
